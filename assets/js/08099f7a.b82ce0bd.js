"use strict";(globalThis.webpackChunksite=globalThis.webpackChunksite||[]).push([[5695],{8453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>o});var r=n(6540);const s={},a=r.createContext(s);function i(e){const t=r.useContext(a);return r.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(a.Provider,{value:t},e.children)}},9121:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>i,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"getting-started/observability-and-ops","title":"Observe & Operate","description":"With Redis/Postgres in place, it\u2019s time to watch the system run. This guide","source":"@site/docs/getting-started/observability-and-ops.md","sourceDirName":"getting-started","slug":"/getting-started/observability-and-ops","permalink":"/stem/getting-started/observability-and-ops","draft":false,"unlisted":false,"editUrl":"https://github.com/kingwill101/stem/tree/main/.site/docs/docs/getting-started/observability-and-ops.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"title":"Observe & Operate","sidebar_label":"Observe & Operate","sidebar_position":4,"slug":"/getting-started/observability-and-ops"},"sidebar":"docs","previous":{"title":"Infrastructure","permalink":"/stem/getting-started/developer-environment"},"next":{"title":"Production Checklist","permalink":"/stem/getting-started/production-checklist"}}');var s=n(4848),a=n(8453);const i={title:"Observe & Operate",sidebar_label:"Observe & Operate",sidebar_position:4,slug:"/getting-started/observability-and-ops"},o=void 0,l={},c=[{value:"1. Enable OpenTelemetry Export",id:"1-enable-opentelemetry-export",level:2},{value:"2. Inspect Worker Heartbeats &amp; Status",id:"2-inspect-worker-heartbeats--status",level:2},{value:"3. Operate Workers via the Control Channel",id:"3-operate-workers-via-the-control-channel",level:2},{value:"4. Manage Queues, Retries, and DLQ",id:"4-manage-queues-retries-and-dlq",level:2},{value:"5. Alert on Scheduler Drift &amp; Schedules",id:"5-alert-on-scheduler-drift--schedules",level:2},{value:"6. React to Signals for Custom Integrations",id:"6-react-to-signals-for-custom-integrations",level:2},{value:"7. Next Stop",id:"7-next-stop",level:2}];function d(e){const t={a:"a",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.p,{children:"With Redis/Postgres in place, it\u2019s time to watch the system run. This guide\ncovers telemetry, worker heartbeats, DLQ tooling, and the remote-control\nchannel\u2014all the pieces you need to operate Stem confidently."}),"\n",(0,s.jsx)(t.h2,{id:"1-enable-opentelemetry-export",children:"1. Enable OpenTelemetry Export"}),"\n",(0,s.jsxs)(t.p,{children:["Stem emits metrics, traces, and structured logs out of the box. Point it at an\nOTLP endpoint (the repo ships a ready-made stack under ",(0,s.jsx)(t.code,{children:"examples/otel_metrics/"}),"):"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:'# Start the example collector, Prometheus, and Grafana stack.\ndocker compose -f examples/otel_metrics/docker-compose.yml up\n\n# Export OTLP details for producers and workers.\nexport STEM_OTLP_ENDPOINT=http://localhost:4318\nexport STEM_OTLP_HEADERS="authorization=Basic c3RlbTpwYXNz"\nexport STEM_OTLP_METRICS_INTERVAL=10s\nexport STEM_LOG_FORMAT=json\n'})}),"\n",(0,s.jsxs)(t.p,{children:["In Dart, no extra code is required\u2014the env vars activate exporters. Metrics\ninclude queue depth, retry counts, lease renewals, and worker concurrency;\ntraces connect ",(0,s.jsx)(t.code,{children:"Stem.enqueue"})," spans with worker execution spans so you can\nfollow a task end-to-end."]}),"\n",(0,s.jsx)(t.p,{children:"If you want an explicit in-process configuration, wire metrics and tracing\ndirectly:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-dart",metastring:'title="Configure metrics" file=<rootDir>/../packages/stem/example/docs_snippets/lib/observability.dart#observability-metrics',children:"void configureMetrics() {\n  StemMetrics.instance.configure(exporters: [ConsoleMetricsExporter()]);\n}\n"})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-dart",metastring:'title="Tracing-enabled Stem" file=<rootDir>/../packages/stem/example/docs_snippets/lib/observability.dart#observability-tracing',children:"Stem buildTracedStem(\n  Broker broker,\n  ResultBackend backend,\n  TaskRegistry registry,\n) {\n  // Configure OpenTelemetry globally; StemTracer.instance reads from it.\n  final _ = StemTracer.instance;\n  return Stem(\n    broker: broker,\n    registry: registry,\n    backend: backend,\n  );\n}\n"})}),"\n",(0,s.jsx)(t.h2,{id:"2-inspect-worker-heartbeats--status",children:"2. Inspect Worker Heartbeats & Status"}),"\n",(0,s.jsx)(t.p,{children:"Workers publish detailed heartbeats (in-flight counts, leases, queues) to the\nresult backend. Use the CLI to view them live:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:'# Snapshot the latest heartbeat for every worker.\nstem worker status \\\n  --backend "$STEM_RESULT_BACKEND_URL"\n\n# Stream live updates (press Ctrl+C to stop).\nstem worker status \\\n  --broker "$STEM_BROKER_URL" \\\n  --follow\n'})}),"\n",(0,s.jsx)(t.p,{children:"From Dart you can pull the same data:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-dart",metastring:"file=<rootDir>/../packages/stem/example/docs_snippets/lib/observability_ops.dart#ops-heartbeats",children:"Future<void> listWorkerHeartbeats() async {\n  final backend = await RedisResultBackend.connect(\n    Platform.environment['STEM_RESULT_BACKEND_URL']!,\n  );\n  final heartbeats = await backend.listWorkerHeartbeats();\n  for (final hb in heartbeats) {\n    print('${hb.workerId} -> queues=${hb.queues} inflight=${hb.inflight}');\n  }\n  await backend.close();\n}\n"})}),"\n",(0,s.jsx)(t.h2,{id:"3-operate-workers-via-the-control-channel",children:"3. Operate Workers via the Control Channel"}),"\n",(0,s.jsx)(t.p,{children:"Stem exposes a built-in control bus so you can interact with workers without\nSSH or custom wiring."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"# Discover workers and latency.\nstem worker ping\n\n# Collect stats (queues, concurrency, runtimes) as JSON.\nstem worker stats --json\n\n# Revoke a problematic task globally (optionally terminate in-flight).\nstem worker revoke \\\n  --task 1f23c6a1-... \\\n  --terminate \\\n\n# Issue a warm shutdown to drain work gracefully.\nstem worker shutdown \\\n  --worker default@host-a\n"})}),"\n",(0,s.jsx)(t.p,{children:"Need to manage multiple instances on one host? Ship the bundled daemonization\ntemplates or lean on the multi-wrapper:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:'# Launch and supervise multiple workers with templated PID/log files.\nstem worker multi start alpha beta \\\n  --pidfile /var/run/stem/%n.pid \\\n  --logfile /var/log/stem/%n.log \\\n  --command "/usr/bin/dart run bin/worker.dart"\n\n# Drain and stop the same fleet.\nstem worker multi stop alpha beta\n'})}),"\n",(0,s.jsx)(t.h2,{id:"4-manage-queues-retries-and-dlq",children:"4. Manage Queues, Retries, and DLQ"}),"\n",(0,s.jsx)(t.p,{children:"The CLI exposes queues, retries, and dead letters so operators can recover\nquickly."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"# Inspect queue depth and inflight counts.\nstem observe queues\n\n# Inspect worker snapshots from the result backend.\nstem observe workers\n\n# Inspect the dead-letter queue with pagination.\nstem dlq list --queue default --limit 20\n\n# Replay failed tasks back onto their original queues.\nstem dlq replay --queue default --limit 10 --confirm\n"})}),"\n",(0,s.jsx)(t.p,{children:"Behind the scenes the CLI talks to the same Redis data structures used by\nworkers, so you see the exact state the runtime is using."}),"\n",(0,s.jsx)(t.h2,{id:"5-alert-on-scheduler-drift--schedules",children:"5. Alert on Scheduler Drift & Schedules"}),"\n",(0,s.jsx)(t.p,{children:"Beat records run history, drift, and errors. Keep an eye on it with:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:'stem observe schedules \\\n  --file config/schedules.yaml\n\nstem schedule dry-run --spec "every:5m" --count 5\n'})}),"\n",(0,s.jsx)(t.p,{children:"These commands surface the same drift metrics your Grafana dashboards chart and\nhelp confirm schedule definitions before they go live."}),"\n",(0,s.jsx)(t.h2,{id:"6-react-to-signals-for-custom-integrations",children:"6. React to Signals for Custom Integrations"}),"\n",(0,s.jsx)(t.p,{children:"Signals fire for task, worker, and scheduler lifecycle events. Wire them into\nchat, incident tooling, or analytics:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-dart",metastring:'title="lib/analytics.dart" file=<rootDir>/../packages/stem/example/docs_snippets/lib/observability_ops.dart#ops-analytics',children:"void installAnalytics() {\n  StemSignals.taskRetry.connect((payload, _) {\n    print('Task ${payload.envelope.name} retry ${payload.attempt}');\n  });\n\n  StemSignals.workerHeartbeat.connect((payload, _) {\n    if (payload.worker.queues.length > 100) {\n      // Send to your alerting system.\n    }\n  });\n\n  StemSignals.scheduleEntryFailed.connect((payload, _) {\n    print('Scheduler entry ${payload.entry.id} failed: ${payload.error}');\n  });\n}\n"})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-dart",metastring:'title="Signal handlers" file=<rootDir>/../packages/stem/example/docs_snippets/lib/observability.dart#observability-signals',children:"void registerSignals() {\n  StemSignals.taskRetry.connect((payload, _) {\n    metrics.recordRetry(delay: payload.nextRetryAt.difference(DateTime.now()));\n  });\n\n  StemSignals.workerHeartbeat.connect((payload, _) {\n    heartbeatGauge.set(1, tags: {'worker': payload.worker.id});\n  });\n}\n"})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-dart",metastring:'title="Structured logging" file=<rootDir>/../packages/stem/example/docs_snippets/lib/observability.dart#observability-logging',children:"void logTaskStart(Envelope envelope) {\n  stemLogger.info(\n    'Task started',\n    Context({'task': envelope.name, 'id': envelope.id}),\n  );\n}\n"})}),"\n",(0,s.jsx)(t.p,{children:"Combine signal handlers with telemetry to build rich observability without\nscattering logic across the codebase."}),"\n",(0,s.jsx)(t.h2,{id:"7-next-stop",children:"7. Next Stop"}),"\n",(0,s.jsxs)(t.p,{children:["You now have dashboards, CLI tooling, and remote control over workers. Finish\nthe onboarding journey by applying security hardening, TLS, and production\nchecklists in ",(0,s.jsx)(t.a,{href:"/stem/getting-started/production-checklist",children:"Prepare for Production"}),"."]}),"\n",(0,s.jsx)(t.p,{children:"If you want more hands-on drills:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["Run ",(0,s.jsx)(t.code,{children:"example/ops_health_suite"})," to practice ",(0,s.jsx)(t.code,{children:"stem health"})," and ",(0,s.jsx)(t.code,{children:"stem observe"})," flows."]}),"\n",(0,s.jsxs)(t.li,{children:["Run ",(0,s.jsx)(t.code,{children:"example/scheduler_observability"})," to watch drift metrics and schedule signals."]}),"\n"]})]})}function p(e={}){const{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}}}]);