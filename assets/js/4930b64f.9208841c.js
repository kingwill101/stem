"use strict";(globalThis.webpackChunksite=globalThis.webpackChunksite||[]).push([[4217],{1470:(e,t,r)=>{r.d(t,{A:()=>w});var n=r(6540),a=r(4164),s=r(7559),i=r(3104),l=r(6347),o=r(205),d=r(7485),c=r(1682),u=r(679);function p(e){return n.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,n.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function h(e){const{values:t,children:r}=e;return(0,n.useMemo)(()=>{const e=t??function(e){return p(e).map(({props:{value:e,label:t,attributes:r,default:n}})=>({value:e,label:t,attributes:r,default:n}))}(r);return function(e){const t=(0,c.XI)(e,(e,t)=>e.value===t.value);if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e},[t,r])}function b({value:e,tabValues:t}){return t.some(t=>t.value===e)}function g({queryString:e=!1,groupId:t}){const r=(0,l.W6)(),a=function({queryString:e=!1,groupId:t}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!t)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return t??null}({queryString:e,groupId:t});return[(0,d.aZ)(a),(0,n.useCallback)(e=>{if(!a)return;const t=new URLSearchParams(r.location.search);t.set(a,e),r.replace({...r.location,search:t.toString()})},[a,r])]}function m(e){const{defaultValue:t,queryString:r=!1,groupId:a}=e,s=h(e),[i,l]=(0,n.useState)(()=>function({defaultValue:e,tabValues:t}){if(0===t.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!b({value:e,tabValues:t}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${t.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}const r=t.find(e=>e.default)??t[0];if(!r)throw new Error("Unexpected error: 0 tabValues");return r.value}({defaultValue:t,tabValues:s})),[d,c]=g({queryString:r,groupId:a}),[p,m]=function({groupId:e}){const t=function(e){return e?`docusaurus.tab.${e}`:null}(e),[r,a]=(0,u.Dv)(t);return[r,(0,n.useCallback)(e=>{t&&a.set(e)},[t,a])]}({groupId:a}),k=(()=>{const e=d??p;return b({value:e,tabValues:s})?e:null})();(0,o.A)(()=>{k&&l(k)},[k]);return{selectedValue:i,selectValue:(0,n.useCallback)(e=>{if(!b({value:e,tabValues:s}))throw new Error(`Can't select invalid tab value=${e}`);l(e),c(e),m(e)},[c,m,s]),tabValues:s}}var k=r(2303);const v={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var f=r(4848);function y({className:e,block:t,selectedValue:r,selectValue:n,tabValues:s}){const l=[],{blockElementScrollPositionUntilNextRender:o}=(0,i.a_)(),d=e=>{const t=e.currentTarget,a=l.indexOf(t),i=s[a].value;i!==r&&(o(t),n(i))},c=e=>{let t=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":{const r=l.indexOf(e.currentTarget)+1;t=l[r]??l[0];break}case"ArrowLeft":{const r=l.indexOf(e.currentTarget)-1;t=l[r]??l[l.length-1];break}}t?.focus()};return(0,f.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,a.A)("tabs",{"tabs--block":t},e),children:s.map(({value:e,label:t,attributes:n})=>(0,f.jsx)("li",{role:"tab",tabIndex:r===e?0:-1,"aria-selected":r===e,ref:e=>{l.push(e)},onKeyDown:c,onClick:d,...n,className:(0,a.A)("tabs__item",v.tabItem,n?.className,{"tabs__item--active":r===e}),children:t??e},e))})}function x({lazy:e,children:t,selectedValue:r}){const s=(Array.isArray(t)?t:[t]).filter(Boolean);if(e){const e=s.find(e=>e.props.value===r);return e?(0,n.cloneElement)(e,{className:(0,a.A)("margin-top--md",e.props.className)}):null}return(0,f.jsx)("div",{className:"margin-top--md",children:s.map((e,t)=>(0,n.cloneElement)(e,{key:t,hidden:e.props.value!==r}))})}function j(e){const t=m(e);return(0,f.jsxs)("div",{className:(0,a.A)(s.G.tabs.container,"tabs-container",v.tabList),children:[(0,f.jsx)(y,{...t,...e}),(0,f.jsx)(x,{...t,...e})]})}function w(e){const t=(0,k.A)();return(0,f.jsx)(j,{...e,children:p(e.children)},String(t))}},4242:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>c,contentTitle:()=>d,default:()=>h,frontMatter:()=>o,metadata:()=>n,toc:()=>u});const n=JSON.parse('{"id":"getting-started/reliability","title":"Reliability Guide","description":"This guide summarizes reliability practices for task systems using Stem.","source":"@site/docs/getting-started/reliability.md","sourceDirName":"getting-started","slug":"/getting-started/reliability","permalink":"/stem/getting-started/reliability","draft":false,"unlisted":false,"editUrl":"https://github.com/kingwill101/stem/tree/main/.site/docs/docs/getting-started/reliability.md","tags":[],"version":"current","sidebarPosition":10,"frontMatter":{"title":"Reliability Guide","sidebar_label":"Reliability","sidebar_position":10,"slug":"/getting-started/reliability"},"sidebar":"docs","previous":{"title":"Best Practices","permalink":"/stem/getting-started/best-practices"},"next":{"title":"Monitoring","permalink":"/stem/getting-started/monitoring"}}');var a=r(4848),s=r(8453),i=r(1470),l=r(9365);const o={title:"Reliability Guide",sidebar_label:"Reliability",sidebar_position:10,slug:"/getting-started/reliability"},d=void 0,c={},u=[{value:"Recovery workflow",id:"recovery-workflow",level:2},{value:"Broker fetch notes",id:"broker-fetch-notes",level:2},{value:"Workflow lease notes",id:"workflow-lease-notes",level:2},{value:"Poison-pill handling",id:"poison-pill-handling",level:2},{value:"Scheduler reliability",id:"scheduler-reliability",level:2},{value:"Retries and backoff",id:"retries-and-backoff",level:2},{value:"Heartbeats and progress",id:"heartbeats-and-progress",level:2},{value:"Observability signals",id:"observability-signals",level:2},{value:"Operational checks",id:"operational-checks",level:2},{value:"Next steps",id:"next-steps",level:2}];function p(e){const t={a:"a",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(t.p,{children:"This guide summarizes reliability practices for task systems using Stem."}),"\n","\n",(0,a.jsx)(t.h2,{id:"recovery-workflow",children:"Recovery workflow"}),"\n",(0,a.jsxs)(t.ol,{children:["\n",(0,a.jsx)(t.li,{children:"Identify the failing task or queue."}),"\n",(0,a.jsx)(t.li,{children:"Inspect recent errors and DLQ entries."}),"\n",(0,a.jsx)(t.li,{children:"Fix the root cause before replaying."}),"\n",(0,a.jsx)(t.li,{children:"Replay only the affected tasks."}),"\n"]}),"\n",(0,a.jsx)(t.h2,{id:"broker-fetch-notes",children:"Broker fetch notes"}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsxs)(t.li,{children:[(0,a.jsx)(t.strong,{children:"Redis Streams"})," uses consumer groups plus ",(0,a.jsx)(t.code,{children:"XAUTOCLAIM"})," to reclaim idle\ndeliveries; long-running tasks should emit heartbeats or extend leases."]}),"\n",(0,a.jsxs)(t.li,{children:[(0,a.jsx)(t.strong,{children:"Postgres"})," uses polling with ",(0,a.jsx)(t.code,{children:"locked_until"})," leases; tasks become visible\nagain after the lease expires."]}),"\n"]}),"\n",(0,a.jsx)(t.h2,{id:"workflow-lease-notes",children:"Workflow lease notes"}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsx)(t.li,{children:"Workflow runs are lease-based. Workers must renew leases while executing, and\nother workers can take over after the lease expires."}),"\n",(0,a.jsxs)(t.li,{children:["Keep ",(0,a.jsx)(t.code,{children:"runLeaseDuration"})," ",(0,a.jsx)(t.strong,{children:">="})," broker visibility timeout to prevent\nredelivered workflow tasks from being dropped before takeover is possible."]}),"\n",(0,a.jsxs)(t.li,{children:["Keep ",(0,a.jsx)(t.code,{children:"leaseExtension"})," renewals ahead of both the workflow lease expiry and the\nbroker visibility timeout."]}),"\n"]}),"\n",(0,a.jsx)(t.h2,{id:"poison-pill-handling",children:"Poison-pill handling"}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsx)(t.li,{children:"If a task fails repeatedly for the same reason, treat it as a poison pill."}),"\n",(0,a.jsx)(t.li,{children:"Move it to the DLQ and add guardrails or validation to prevent repeats."}),"\n",(0,a.jsx)(t.li,{children:"Record the failure pattern for future detection."}),"\n"]}),"\n",(0,a.jsx)(t.h2,{id:"scheduler-reliability",children:"Scheduler reliability"}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsx)(t.li,{children:"Run multiple Beat instances only when backed by a shared lock store."}),"\n",(0,a.jsx)(t.li,{children:"Monitor schedule drift and failures to detect store latency."}),"\n",(0,a.jsx)(t.li,{children:"Re-apply schedules after deploys to ensure definitions stay current."}),"\n"]}),"\n",(0,a.jsx)(t.h2,{id:"retries-and-backoff",children:"Retries and backoff"}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsx)(t.li,{children:"Use bounded retries with jittered backoff to avoid thundering herds."}),"\n",(0,a.jsx)(t.li,{children:"Separate transient failures from permanent failures."}),"\n",(0,a.jsx)(t.li,{children:"For permanent errors, fail fast and alert."}),"\n"]}),"\n",(0,a.jsxs)(i.A,{children:[(0,a.jsx)(l.A,{value:"worker-retry",label:"Configure a jittered retry strategy",children:(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-dart",metastring:'title="retry_task/bin/worker.dart" file=<rootDir>/../packages/stem/example/retry_task/bin/worker.dart#reliability-retry-worker',children:"  final worker = Worker(\n    broker: broker,\n    registry: registry,\n    backend: backend,\n    queue: 'retry-demo',\n    consumerName: workerName,\n    retryStrategy: ExponentialJitterRetryStrategy(\n      base: const Duration(milliseconds: 200),\n      max: const Duration(seconds: 1),\n    ),\n  );\n"})})}),(0,a.jsx)(l.A,{value:"signals",label:"Log retry signals and outcomes",children:(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-dart",metastring:'title="retry_task/lib/shared.dart" file=<rootDir>/../packages/stem/example/retry_task/lib/shared.dart#reliability-retry-signals',children:"List<SignalSubscription> attachLogging(String label) {\n  String prefix(String event) => '[retry][$label][$event]';\n\n  void log(String event, Map<String, Object?> data) {\n    // ignore: avoid_print\n    print('${prefix(event)} ${jsonEncode(data)}');\n  }\n\n  return <SignalSubscription>[\n    StemSignals.onBeforeTaskPublish((payload, context) {\n      log('before_task_publish', {\n        'task': payload.envelope.name,\n        'id': payload.envelope.id,\n        'attempt': payload.attempt,\n        'sender': context.sender,\n      });\n    }),\n    StemSignals.onTaskPrerun((payload, _) {\n      log('task_prerun', {\n        'task': payload.envelope.name,\n        'id': payload.envelope.id,\n        'attempt': payload.context.attempt,\n        'worker': payload.worker.id,\n      });\n    }),\n    StemSignals.onTaskRetry((payload, _) {\n      log('task_retry', {\n        'task': payload.envelope.name,\n        'id': payload.envelope.id,\n        'attempt': payload.attempt,\n        'reason': payload.reason.toString(),\n        'nextRunAt': payload.nextRetryAt.toIso8601String(),\n        'worker': payload.worker.id,\n      });\n    }),\n    StemSignals.onTaskFailure((payload, _) {\n      log('task_failed', {\n        'task': payload.envelope.name,\n        'id': payload.envelope.id,\n        'attempt': payload.attempt,\n        'worker': payload.worker.id,\n        'error': payload.error.toString(),\n      });\n    }),\n    StemSignals.onTaskPostrun((payload, _) {\n      log('task_postrun', {\n        'task': payload.envelope.name,\n        'id': payload.envelope.id,\n        'state': payload.state.name,\n        'worker': payload.worker.id,\n      });\n    }),\n  ];\n}\n"})})}),(0,a.jsx)(l.A,{value:"task",label:"Create a task that exercises retries",children:(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-dart",metastring:'title="retry_task/lib/shared.dart" file=<rootDir>/../packages/stem/example/retry_task/lib/shared.dart#reliability-retry-entrypoint',children:"FutureOr<void> _alwaysFailEntrypoint(\n  TaskInvocationContext context,\n  Map<String, Object?> args,\n) {\n  final attempt = context.attempt;\n  final max = context.meta['maxRetries'] ?? 3;\n  // ignore: avoid_print\n  print('[retry][task][attempt] {\"attempt\":$attempt,\"max\":$max}');\n  throw StateError('Simulated failure on attempt $attempt');\n}\n"})})})]}),"\n",(0,a.jsx)(t.h2,{id:"heartbeats-and-progress",children:"Heartbeats and progress"}),"\n",(0,a.jsx)(t.p,{children:"Use heartbeats and progress updates to prevent long-running tasks from being\nreclaimed prematurely."}),"\n",(0,a.jsxs)(i.A,{children:[(0,a.jsx)(l.A,{value:"heartbeat",label:"Configure worker heartbeat intervals",children:(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-dart",metastring:'title="progress_heartbeat/bin/worker.dart" file=<rootDir>/../packages/stem/example/progress_heartbeat/bin/worker.dart#reliability-heartbeat-worker',children:"  final worker = Worker(\n    broker: broker,\n    registry: registry,\n    backend: backend,\n    queue: progressQueue,\n    subscription: RoutingSubscription.singleQueue(progressQueue),\n    consumerName: workerName,\n    heartbeatInterval: const Duration(seconds: 2),\n    workerHeartbeatInterval: const Duration(seconds: 5),\n    prefetchMultiplier: 1,\n  );\n"})})}),(0,a.jsx)(l.A,{value:"progress",label:"Emit progress and heartbeats inside a task",children:(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-dart",metastring:'title="progress_heartbeat/lib/shared.dart" file=<rootDir>/../packages/stem/example/progress_heartbeat/lib/shared.dart#reliability-progress-task',children:"class ProgressTask extends TaskHandler<String> {\n  @override\n  String get name => 'progress.demo';\n\n  @override\n  TaskOptions get options => const TaskOptions(queue: progressQueue);\n\n  @override\n  TaskMetadata get metadata => const TaskMetadata(\n        description: 'Task that reports progress and heartbeats on a loop.',\n        tags: ['progress', 'heartbeat'],\n      );\n\n  @override\n  Future<String> call(TaskContext context, Map<String, Object?> args) async {\n    final steps = (args['steps'] as num?)?.toInt() ?? 10;\n    final delayMs = (args['delayMs'] as num?)?.toInt() ?? 800;\n\n    stdout.writeln('[task][start] id=${context.id} steps=$steps');\n\n    for (var i = 0; i < steps; i += 1) {\n      context.heartbeat();\n      await context.progress(\n        (i + 1) / steps,\n        data: {'step': i + 1, 'total': steps},\n      );\n      await Future<void>.delayed(Duration(milliseconds: delayMs));\n    }\n\n    stdout.writeln('[task][done] id=${context.id}');\n    return 'ok';\n  }\n}\n"})})}),(0,a.jsx)(l.A,{value:"events",label:"Stream worker events for observability",children:(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-dart",metastring:'title="progress_heartbeat/lib/shared.dart" file=<rootDir>/../packages/stem/example/progress_heartbeat/lib/shared.dart#reliability-worker-event-logging',children:"void attachWorkerEventLogging(Worker worker) {\n  worker.events.listen((event) {\n    switch (event.type) {\n      case WorkerEventType.progress:\n        stdout.writeln(\n          '[event][progress] id=${event.envelope?.id} progress=${event.progress} data=${event.data}',\n        );\n        break;\n      case WorkerEventType.heartbeat:\n        stdout.writeln('[event][heartbeat] id=${event.envelopeId}');\n        break;\n      case WorkerEventType.completed:\n        stdout.writeln('[event][completed] id=${event.envelope?.id}');\n        break;\n      case WorkerEventType.failed:\n        stdout.writeln('[event][failed] id=${event.envelope?.id}');\n        break;\n      case WorkerEventType.revoked:\n        stdout.writeln('[event][revoked] id=${event.envelope?.id}');\n        break;\n      case WorkerEventType.retried:\n      case WorkerEventType.timeout:\n      case WorkerEventType.error:\n        stdout.writeln('[event][${event.type.name}] id=${event.envelope?.id}');\n        break;\n    }\n  });\n}\n"})})})]}),"\n",(0,a.jsx)(t.h2,{id:"observability-signals",children:"Observability signals"}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsx)(t.li,{children:"Track retry rates and DLQ volume as reliability signals."}),"\n",(0,a.jsx)(t.li,{children:"Monitor queue backlog and worker heartbeats to detect stalls."}),"\n",(0,a.jsx)(t.li,{children:"Tie task IDs to business logs for fast root-cause analysis."}),"\n",(0,a.jsxs)(t.li,{children:["Use ",(0,a.jsx)(t.code,{children:"StemSignals.taskRetry"})," / ",(0,a.jsx)(t.code,{children:"taskFailed"})," to drive notifications when error\nrates spike."]}),"\n"]}),"\n",(0,a.jsx)(t.h2,{id:"operational-checks",children:"Operational checks"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-bash",children:'stem health --broker "$STEM_BROKER_URL" --backend "$STEM_RESULT_BACKEND_URL"\nstem observe queues\nstem observe workers\nstem dlq list --queue <queue>\n'})}),"\n",(0,a.jsx)(t.h2,{id:"next-steps",children:"Next steps"}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsx)(t.li,{children:(0,a.jsx)(t.a,{href:"/stem/getting-started/troubleshooting",children:"Troubleshooting"})}),"\n",(0,a.jsx)(t.li,{children:(0,a.jsx)(t.a,{href:"/stem/getting-started/observability-and-ops",children:"Observability & Ops"})}),"\n",(0,a.jsx)(t.li,{children:(0,a.jsx)(t.a,{href:"/stem/workers/control",children:"Worker Control CLI"})}),"\n"]})]})}function h(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(p,{...e})}):p(e)}},8453:(e,t,r)=>{r.d(t,{R:()=>i,x:()=>l});var n=r(6540);const a={},s=n.createContext(a);function i(e){const t=n.useContext(s);return n.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function l(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),n.createElement(s.Provider,{value:t},e.children)}},9365:(e,t,r)=>{r.d(t,{A:()=>i});r(6540);var n=r(4164);const a={tabItem:"tabItem_Ymn6"};var s=r(4848);function i({children:e,hidden:t,className:r}){return(0,s.jsx)("div",{role:"tabpanel",className:(0,n.A)(a.tabItem,r),hidden:t,children:e})}}}]);