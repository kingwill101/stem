"use strict";(globalThis.webpackChunksite=globalThis.webpackChunksite||[]).push([[2925],{8453:(e,n,t)=>{t.d(n,{R:()=>c,x:()=>l});var s=t(6540);const r={},i=s.createContext(r);function c(e){const n=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),s.createElement(i.Provider,{value:n},e.children)}},8874:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>c,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"core-concepts/observability","title":"Observability","description":"Instrument Stem applications with built-in metrics, traces, and lifecycle","source":"@site/docs/core-concepts/observability.md","sourceDirName":"core-concepts","slug":"/core-concepts/observability","permalink":"/stem/core-concepts/observability","draft":false,"unlisted":false,"editUrl":"https://github.com/kingwill101/stem/tree/main/.site/docs/docs/core-concepts/observability.md","tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"title":"Observability","sidebar_label":"Observability","sidebar_position":6,"slug":"/core-concepts/observability"},"sidebar":"docs","previous":{"title":"Canvas","permalink":"/stem/core-concepts/canvas"},"next":{"title":"Dashboard","permalink":"/stem/core-concepts/dashboard"}}');var r=t(4848),i=t(8453);const c={title:"Observability",sidebar_label:"Observability",sidebar_position:6,slug:"/core-concepts/observability"},l=void 0,o={},a=[{value:"Metrics",id:"metrics",level:2},{value:"Tracing",id:"tracing",level:2},{value:"Signals",id:"signals",level:2},{value:"Workflow Introspection",id:"workflow-introspection",level:2},{value:"Logging",id:"logging",level:2},{value:"Health checks",id:"health-checks",level:2},{value:"Dashboards",id:"dashboards",level:2}];function d(e){const n={code:"code",h2:"h2",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"Instrument Stem applications with built-in metrics, traces, and lifecycle\nsignals."}),"\n",(0,r.jsx)(n.h2,{id:"metrics",children:"Metrics"}),"\n",(0,r.jsxs)(n.p,{children:["Stem exports OpenTelemetry metrics via ",(0,r.jsx)(n.code,{children:"StemMetrics"}),". Enable exporters with\nenvironment variables or programmatically."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"export STEM_METRIC_EXPORTERS=otlp:http://localhost:4318/v1/metrics\nexport STEM_OTLP_ENDPOINT=http://localhost:4318\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",metastring:"file=<rootDir>/../packages/stem/example/docs_snippets/lib/observability.dart#observability-metrics",children:"void configureMetrics() {\n  StemMetrics.instance.configure(exporters: [ConsoleMetricsExporter()]);\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"Common metric names:"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Metric"}),(0,r.jsx)(n.th,{children:"Type"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"stem.tasks.started"})}),(0,r.jsx)(n.td,{children:"Counter"}),(0,r.jsx)(n.td,{children:"Incremented when a worker begins executing a task."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"stem.tasks.succeeded"})," / ",(0,r.jsx)(n.code,{children:"stem.tasks.failed"})]}),(0,r.jsx)(n.td,{children:"Counter"}),(0,r.jsx)(n.td,{children:"Outcome counters per task/queue."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"stem.tasks.retried"})}),(0,r.jsx)(n.td,{children:"Counter"}),(0,r.jsx)(n.td,{children:"Number of retries scheduled."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"stem.task.duration"})}),(0,r.jsx)(n.td,{children:"Histogram"}),(0,r.jsx)(n.td,{children:"Task execution time in milliseconds."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"stem.worker.concurrency"})}),(0,r.jsx)(n.td,{children:"Gauge"}),(0,r.jsx)(n.td,{children:"Current active isolates vs configured concurrency."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"stem.worker.inflight"})}),(0,r.jsx)(n.td,{children:"Gauge"}),(0,r.jsx)(n.td,{children:"Messages currently reserved by the worker."})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"tracing",children:"Tracing"}),"\n",(0,r.jsx)(n.p,{children:"Wrap enqueue and task handlers with traces by enabling the built-in tracer."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"export STEM_TRACE_EXPORTER=otlp:http://localhost:4318/v1/traces\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",metastring:"file=<rootDir>/../packages/stem/example/docs_snippets/lib/observability.dart#observability-tracing",children:"Stem buildTracedStem(\n  Broker broker,\n  ResultBackend backend,\n  TaskRegistry registry,\n) {\n  // Configure OpenTelemetry globally; StemTracer.instance reads from it.\n  final _ = StemTracer.instance;\n  return Stem(\n    broker: broker,\n    registry: registry,\n    backend: backend,\n  );\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Traces include spans for ",(0,r.jsx)(n.code,{children:"stem.enqueue"}),", ",(0,r.jsx)(n.code,{children:"stem.consume"}),", and task execution.\nUse attributes (",(0,r.jsx)(n.code,{children:"stem.task"}),", ",(0,r.jsx)(n.code,{children:"stem.queue"}),", ",(0,r.jsx)(n.code,{children:"stem.retry.attempt"}),") to filter in\nyour tracing backend."]}),"\n",(0,r.jsx)(n.h2,{id:"signals",children:"Signals"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"StemSignals"})," fire lifecycle hooks for tasks, workers, scheduler events, and\ncontrol-plane commands."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",metastring:"file=<rootDir>/../packages/stem/example/docs_snippets/lib/observability.dart#observability-signals",children:"void registerSignals() {\n  StemSignals.taskRetry.connect((payload, _) {\n    metrics.recordRetry(delay: payload.nextRetryAt.difference(DateTime.now()));\n  });\n\n  StemSignals.workerHeartbeat.connect((payload, _) {\n    heartbeatGauge.set(1, tags: {'worker': payload.worker.id});\n  });\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"workflow-introspection",children:"Workflow Introspection"}),"\n",(0,r.jsxs)(n.p,{children:["Workflow runtimes can emit step-level events (started/completed/failed/retrying)\nthrough a ",(0,r.jsx)(n.code,{children:"WorkflowIntrospectionSink"}),". Use it to publish step telemetry or\nbridge to your own tracing/logging systems."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"class LoggingWorkflowIntrospectionSink implements WorkflowIntrospectionSink {\n  @override\n  Future<void> recordStepEvent(WorkflowStepEvent event) async {\n    stemLogger.info('workflow.step', {\n      'run': event.runId,\n      'workflow': event.workflow,\n      'step': event.stepId,\n      'type': event.type.name,\n      'iteration': event.iteration,\n    });\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"logging",children:"Logging"}),"\n",(0,r.jsxs)(n.p,{children:["Use ",(0,r.jsx)(n.code,{children:"stemLogger"})," (Contextual logger) for structured logs."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",metastring:"file=<rootDir>/../packages/stem/example/docs_snippets/lib/observability.dart#observability-logging",children:"void logTaskStart(Envelope envelope) {\n  stemLogger.info(\n    'Task started',\n    Context({'task': envelope.name, 'id': envelope.id}),\n  );\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Workers automatically include attempt, queue, and worker id in log contexts when\n",(0,r.jsx)(n.code,{children:"StemSignals"})," are enabled."]}),"\n",(0,r.jsx)(n.h2,{id:"health-checks",children:"Health checks"}),"\n",(0,r.jsx)(n.p,{children:"Run the CLI to verify connectivity before deployments:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'stem health --broker "$STEM_BROKER_URL" --backend "$STEM_RESULT_BACKEND_URL"\n'})}),"\n",(0,r.jsx)(n.p,{children:"This checks broker/back-end reachability, TLS certificates, and signing\nconfiguration, returning a non-zero exit code on failure."}),"\n",(0,r.jsx)(n.h2,{id:"dashboards",children:"Dashboards"}),"\n",(0,r.jsx)(n.p,{children:"A minimal dashboard typically charts:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Task throughput (",(0,r.jsx)(n.code,{children:"stem.tasks.started"}),", ",(0,r.jsx)(n.code,{children:"stem.tasks.succeeded"}),", ",(0,r.jsx)(n.code,{children:"stem.tasks.failed"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["Retry delay distribution (",(0,r.jsx)(n.code,{children:"stem.tasks.retried"}),", ",(0,r.jsx)(n.code,{children:"stem.task.duration"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["Worker heartbeats and concurrency (",(0,r.jsx)(n.code,{children:"stem.worker.concurrency"}),", ",(0,r.jsx)(n.code,{children:"stem.worker.inflight"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["Scheduler drift (",(0,r.jsx)(n.code,{children:"StemSignals.onScheduleEntryDispatched"})," drift metrics)."]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Exporters can be mixed\u2014enable console during development and OTLP in staging/\nproduction. For local exploration, run the ",(0,r.jsx)(n.code,{children:"examples/otel_metrics"})," stack to see\nmetrics in a collector + Jaeger pipeline."]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}}}]);