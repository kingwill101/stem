"use strict";(globalThis.webpackChunksite=globalThis.webpackChunksite||[]).push([[6760],{1134:(e,r,s)=>{s.r(r),s.d(r,{assets:()=>a,contentTitle:()=>l,default:()=>u,frontMatter:()=>o,metadata:()=>n,toc:()=>d});const n=JSON.parse('{"id":"brokers/caveats","title":"Broker Caveats","description":"This page highlights broker-specific constraints that affect routing, priorities,","source":"@site/docs/brokers/caveats.md","sourceDirName":"brokers","slug":"/brokers/caveats","permalink":"/stem/brokers/caveats","draft":false,"unlisted":false,"editUrl":"https://github.com/kingwill101/stem/tree/main/.site/docs/docs/brokers/caveats.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"title":"Broker Caveats","sidebar_label":"Broker Caveats","sidebar_position":1,"slug":"/brokers/caveats"},"sidebar":"docs","previous":{"title":"Broker Overview","permalink":"/stem/brokers"}}');var i=s(4848),t=s(8453);const o={title:"Broker Caveats",sidebar_label:"Broker Caveats",sidebar_position:1,slug:"/brokers/caveats"},l=void 0,a={},d=[{value:"In-memory broker",id:"in-memory-broker",level:2},{value:"SQLite broker",id:"sqlite-broker",level:2},{value:"Redis Streams broker",id:"redis-streams-broker",level:2},{value:"Postgres broker",id:"postgres-broker",level:2},{value:"Result backend caveat (ordering)",id:"result-backend-caveat-ordering",level:2},{value:"Shutdown semantics (broker impact)",id:"shutdown-semantics-broker-impact",level:2},{value:"Tips",id:"tips",level:2},{value:"Example entrypoints",id:"example-entrypoints",level:2}];function c(e){const r={code:"code",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.p,{children:"This page highlights broker-specific constraints that affect routing, priorities,\nand control-plane behavior. These caveats are based on the adapter\nimplementations."}),"\n",(0,i.jsx)(r.h2,{id:"in-memory-broker",children:"In-memory broker"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"No priority buckets"}),": ",(0,i.jsx)(r.code,{children:"supportsPriority"})," is false, so priorities are not\nenforced."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Single-queue consumption"}),": only one queue can be consumed per subscription."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Not durable"}),": data is lost when the process exits."]}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"sqlite-broker",children:"SQLite broker"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Broadcast scope is in-process"}),": fan-out works for subscribers running in\nthe same process, but cross-process worker control broadcasts are not\nsupported."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Single-queue consumption"}),": only one queue can be consumed per subscription."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Polling-based delivery"}),": tasks are polled on ",(0,i.jsx)(r.code,{children:"pollInterval"})," and claimed\nvia row locks; latency depends on the poll interval."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Single-writer constraint"}),": SQLite allows one writer at a time. Use\nseparate broker/backend files and avoid producer writes to the backend."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Native assets"}),": build CLI bundles (",(0,i.jsx)(r.code,{children:"dart build cli"}),") when using ",(0,i.jsx)(r.code,{children:"sqlite3"}),"\nto ensure the native library is packaged reliably."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Local disk only"}),": avoid network filesystems for WAL-backed SQLite files."]}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"redis-streams-broker",children:"Redis Streams broker"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Single-queue consumption"}),": only one queue can be consumed per subscription."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Priority uses per-queue streams"}),": each priority bucket maps to a dedicated\nstream key."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Delayed delivery"}),": delayed tasks are stored in a sorted set and re-enqueued\nwhen due."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Broadcast channels"}),": broadcasts are stored in per-channel streams and\nconsumed via dedicated consumer groups."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Visibility timeouts"}),": the broker reclaims idle deliveries via\n",(0,i.jsx)(r.code,{children:"XAUTOCLAIM"}),". Extending a lease requeues the task into the delayed set\n(it does not update the original stream entry)."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Key eviction risk"}),": Redis eviction policies can drop stream, delayed, or\ndead-letter keys. Use a maxmemory policy that avoids evicting Stem keys, or\nisolate Stem data in a dedicated Redis instance."]}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"postgres-broker",children:"Postgres broker"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Single-queue consumption"}),": only one queue can be consumed per subscription."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Polling-based delivery"}),": workers poll for due jobs on an interval."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Visibility timeouts"}),": tasks are locked with a ",(0,i.jsx)(r.code,{children:"locked_until"})," lease; if a\nworker dies or stops heartbeating, jobs become visible again after the lease\nexpires."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Dead letter retention"}),": dead letters are retained for a default window\n(7 days) unless configured otherwise."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Broadcast channels"}),": broadcasts are stored in a separate table and read\nalongside queue deliveries."]}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"result-backend-caveat-ordering",children:"Result backend caveat (ordering)"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Group result ordering"}),": group/chord results are stored as maps\n(Redis hashes / Postgres tables) and returned without ordering guarantees.\nIf you need stable ordering, sort results by task id or track ordering in\ngroup metadata."]}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"shutdown-semantics-broker-impact",children:"Shutdown semantics (broker impact)"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Soft shutdowns are cooperative"}),": brokers only see acknowledgements (or\nrequeues). If a worker stops without acking a delivery, the task becomes\nvisible again after the visibility lease expires (Redis reclaim interval /\nPostgres ",(0,i.jsx)(r.code,{children:"locked_until"}),")."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Long-running tasks"})," should emit heartbeats or extend leases so the broker\ndoes not re-deliver them mid-execution."]}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"tips",children:"Tips"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"Use routing subscriptions to pin workers to a single queue when using Redis\nor Postgres."}),"\n",(0,i.jsx)(r.li,{children:"Prefer Redis when you need low-latency delivery and high throughput."}),"\n",(0,i.jsx)(r.li,{children:"Prefer Postgres when you need SQL visibility and a single durable store."}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"example-entrypoints",children:"Example entrypoints"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-dart",metastring:'title="brokers.dart" file=<rootDir>/../packages/stem/example/docs_snippets/lib/brokers.dart#brokers-in-memory',children:"InMemoryBroker createInMemoryBroker() {\n  return InMemoryBroker();\n}\n"})}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-dart",metastring:'title="brokers.dart" file=<rootDir>/../packages/stem/example/docs_snippets/lib/brokers.dart#brokers-redis',children:"Future<RedisStreamsBroker> connectRedisBroker() {\n  return RedisStreamsBroker.connect('redis://127.0.0.1:6379/0');\n}\n"})}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-dart",metastring:'title="brokers.dart" file=<rootDir>/../packages/stem/example/docs_snippets/lib/brokers.dart#brokers-postgres',children:"Future<PostgresBroker> connectPostgresBroker() {\n  return PostgresBroker.connect('postgres://localhost:5432/stem');\n}\n"})}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-dart",metastring:'title="brokers.dart" file=<rootDir>/../packages/stem/example/docs_snippets/lib/brokers.dart#brokers-sqlite',children:"Future<SqliteBroker> connectSqliteBroker() {\n  final file = File('stem_broker.sqlite');\n  return SqliteBroker.open(file);\n}\n"})})]})}function u(e={}){const{wrapper:r}={...(0,t.R)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},8453:(e,r,s)=>{s.d(r,{R:()=>o,x:()=>l});var n=s(6540);const i={},t=n.createContext(i);function o(e){const r=n.useContext(t);return n.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function l(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),n.createElement(t.Provider,{value:r},e.children)}}}]);