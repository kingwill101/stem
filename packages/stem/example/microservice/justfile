import "../Justfile.common"

ROOT := justfile_directory()

COMPOSE_FILE := env_var_or_default("COMPOSE_FILE", "docker-compose.yml")
DEPS_SERVICES := env_var_or_default("DEPS_SERVICES", "redis otel-collector jaeger prometheus grafana")
BUILD_DIR := env_var_or_default("BUILD_DIR", "build")
ENV_FILE := env_var_or_default("ENV_FILE", ".env")
SESSION := env_var_or_default("SESSION", "stem-microservice")
PROJECT_NAME := env_var_or_default("PROJECT_NAME", SESSION)
COMPOSE_ENV := "REDIS_PORT=" + REDIS_PORT + " " + "OTEL_GRPC_PORT=" + OTEL_GRPC_PORT + " " + "OTEL_HTTP_PORT=" + OTEL_HTTP_PORT + " " + "OTEL_PROM_PORT=" + OTEL_PROM_PORT
REDIS_PORT := env_var_or_default("REDIS_PORT", "6379")
OTEL_GRPC_PORT := env_var_or_default("OTEL_GRPC_PORT", "4317")
OTEL_HTTP_PORT := env_var_or_default("OTEL_HTTP_PORT", "4318")
OTEL_PROM_PORT := env_var_or_default("OTEL_PROM_PORT", "8889")
DASHBOARD_HOST := env_var_or_default("DASHBOARD_HOST", "127.0.0.1")
DASHBOARD_PORT := env_var_or_default("DASHBOARD_PORT", "3080")



build-worker:
    cd "{{ROOT}}/worker"; dart pub get; dart build cli -o "{{BUILD_DIR}}"

build-enqueuer:
    cd "{{ROOT}}/enqueuer"; dart pub get; dart build cli -o "{{BUILD_DIR}}"

build-beat:
    cd "{{ROOT}}/beat"; dart pub get; dart build cli -o "{{BUILD_DIR}}"

build: build-worker build-enqueuer build-beat

build-dashboard:
    cd "{{ROOT}}/../../../dashboard"; dart pub get; dart build cli -t bin/dashboard.dart -o "{{BUILD_DIR}}"

run-worker:
    cd "{{ROOT}}/worker"; if [ -f "{{ENV_FILE}}" ]; then set -a; . "{{ENV_FILE}}"; set +a; elif [ -f "{{ROOT}}/{{ENV_FILE}}" ]; then set -a; . "{{ROOT}}/{{ENV_FILE}}"; set +a; fi; export REDIS_PORT="${REDIS_PORT:-6379}"; export STEM_BROKER_URL="${STEM_BROKER_URL:-redis://localhost:${REDIS_PORT}/0}"; export STEM_RESULT_BACKEND_URL="${STEM_RESULT_BACKEND_URL:-redis://localhost:${REDIS_PORT}/1}"; "{{BUILD_DIR}}/bundle/bin"/*

run-enqueuer:
    cd "{{ROOT}}/enqueuer"; if [ -f "{{ENV_FILE}}" ]; then set -a; . "{{ENV_FILE}}"; set +a; elif [ -f "{{ROOT}}/{{ENV_FILE}}" ]; then set -a; . "{{ROOT}}/{{ENV_FILE}}"; set +a; fi; export REDIS_PORT="${REDIS_PORT:-6379}"; export STEM_BROKER_URL="${STEM_BROKER_URL:-redis://localhost:${REDIS_PORT}/0}"; export STEM_RESULT_BACKEND_URL="${STEM_RESULT_BACKEND_URL:-redis://localhost:${REDIS_PORT}/1}"; "{{BUILD_DIR}}/bundle/bin"/*

run-beat:
    cd "{{ROOT}}/beat"; if [ -f "{{ENV_FILE}}" ]; then set -a; . "{{ENV_FILE}}"; set +a; elif [ -f "{{ROOT}}/{{ENV_FILE}}" ]; then set -a; . "{{ROOT}}/{{ENV_FILE}}"; set +a; fi; export REDIS_PORT="${REDIS_PORT:-6379}"; export STEM_BROKER_URL="${STEM_BROKER_URL:-redis://localhost:${REDIS_PORT}/0}"; export STEM_SCHEDULE_STORE_URL="${STEM_SCHEDULE_STORE_URL:-redis://localhost:${REDIS_PORT}/2}"; if [ -z "${STEM_SCHEDULE_FILE:-}" ] || [ ! -f "${STEM_SCHEDULE_FILE:-}" ]; then export STEM_SCHEDULE_FILE="{{ROOT}}/schedules.example.yaml"; fi; "{{BUILD_DIR}}/bundle/bin"/*

run-dashboard:
    cd "{{ROOT}}/../../../dashboard"; if [ -f "{{ENV_FILE}}" ]; then set -a; . "{{ENV_FILE}}"; set +a; elif [ -f "{{ROOT}}/{{ENV_FILE}}" ]; then set -a; . "{{ROOT}}/{{ENV_FILE}}"; set +a; fi; export REDIS_PORT="${REDIS_PORT:-6379}"; export STEM_BROKER_URL="${STEM_BROKER_URL:-redis://localhost:${REDIS_PORT}/0}"; export STEM_RESULT_BACKEND_URL="${STEM_RESULT_BACKEND_URL:-redis://localhost:${REDIS_PORT}/1}"; export DASHBOARD_HOST="${DASHBOARD_HOST:-127.0.0.1}"; export DASHBOARD_PORT="${DASHBOARD_PORT:-3080}"; if [ -d "{{BUILD_DIR}}/bundle/bin" ]; then "{{BUILD_DIR}}/bundle/bin"/*; else dart run bin/dashboard.dart; fi

run: run-enqueuer

clean:
    rm -rf "{{ROOT}}/worker/{{BUILD_DIR}}" "{{ROOT}}/enqueuer/{{BUILD_DIR}}" "{{ROOT}}/beat/{{BUILD_DIR}}"

tmux:
    {{JUST}} tmux-guard
    {{JUST}} tmux-prep
    tmux new-session -d -s "{{SESSION}}" -n app "cd \"{{ROOT}}\" && {{JUST}} run-worker"
    tmux split-window -t "{{SESSION}}:app" -v "cd \"{{ROOT}}\" && {{JUST}} run-enqueuer"
    tmux split-window -t "{{SESSION}}:app" -h "cd \"{{ROOT}}\" && {{JUST}} run-beat"
    tmux select-layout -t "{{SESSION}}:app" tiled
    tmux new-window -t "{{SESSION}}" -n dashboard "cd \"{{ROOT}}\" && {{JUST}} run-dashboard"
    {{JUST}} tmux-attach
