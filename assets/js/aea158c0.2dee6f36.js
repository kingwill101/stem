"use strict";(globalThis.webpackChunksite=globalThis.webpackChunksite||[]).push([[5329],{3577:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"getting-started/developer-environment","title":"Connect to Infrastructure","description":"Graduate from the in-memory demo to a multi-process setup backed by Redis or","source":"@site/docs/getting-started/developer-environment.md","sourceDirName":"getting-started","slug":"/getting-started/developer-environment","permalink":"/stem/getting-started/developer-environment","draft":false,"unlisted":false,"editUrl":"https://github.com/kingwill101/stem/tree/main/.site/docs/docs/getting-started/developer-environment.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"title":"Connect to Infrastructure","sidebar_label":"Infrastructure","sidebar_position":3,"slug":"/getting-started/developer-environment"},"sidebar":"docs","previous":{"title":"First Steps","permalink":"/stem/getting-started/first-steps"},"next":{"title":"Observe & Operate","permalink":"/stem/getting-started/observability-and-ops"}}');var s=r(4848),a=r(8453);const o={title:"Connect to Infrastructure",sidebar_label:"Infrastructure",sidebar_position:3,slug:"/getting-started/developer-environment"},i=void 0,l={},d=[{value:"1. Run Redis and Postgres Locally",id:"1-run-redis-and-postgres-locally",level:2},{value:"2. Bootstrap Stem Config",id:"2-bootstrap-stem-config",level:2},{value:"Load configuration",id:"load-configuration",level:3},{value:"Connect adapters",id:"connect-adapters",level:3},{value:"Create the Stem producer",id:"create-the-stem-producer",level:3},{value:"Create the worker",id:"create-the-worker",level:3},{value:"3. Launch Workers, Beat, and Producers",id:"3-launch-workers-beat-and-producers",level:2},{value:"4. Coordinate Work with Canvas and Result Backend",id:"4-coordinate-work-with-canvas-and-result-backend",level:2},{value:"5. Listen to Signals for Cross-Cutting Integrations",id:"5-listen-to-signals-for-cross-cutting-integrations",level:2},{value:"6. What\u2019s Next",id:"6-whats-next",level:2}];function c(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"Graduate from the in-memory demo to a multi-process setup backed by Redis or\nPostgres. You will run workers, Beat, and the CLI in separate terminals while\nexploring routing, broadcast delivery, and canvas composition with persistent\nstorage."}),"\n",(0,s.jsx)(n.h2,{id:"1-run-redis-and-postgres-locally",children:"1. Run Redis and Postgres Locally"}),"\n",(0,s.jsx)(n.p,{children:"Docker is the fastest way to spin up dependencies:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Redis Streams for broker, locks, rate limiting, and schedules.\ndocker run --rm -p 6379:6379 redis:7-alpine\n\n# Postgres for durable task results or schedule storage (optional now, useful later).\ndocker run --rm -p 5432:5432 \\\n  -e POSTGRES_PASSWORD=postgres \\\n  postgres:14\n"})}),"\n",(0,s.jsx)(n.p,{children:"Export the connection details so producers, workers, and Beat share them:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"export STEM_BROKER_URL=redis://localhost:6379\nexport STEM_RESULT_BACKEND_URL=redis://localhost:6379/1\nexport STEM_SCHEDULE_STORE_URL=redis://localhost:6379/2\nexport STEM_CONTROL_NAMESPACE=stem\n"})}),"\n",(0,s.jsx)(n.h2,{id:"2-bootstrap-stem-config",children:"2. Bootstrap Stem Config"}),"\n",(0,s.jsxs)(n.p,{children:["Use ",(0,s.jsx)(n.code,{children:"StemConfig.fromEnvironment()"})," to hydrate adapters from the environment and\nshare them across your app. Split the bootstrap into smaller steps so each\npiece is easy to scan and reuse:"]}),"\n",(0,s.jsx)(n.h3,{id:"load-configuration",children:"Load configuration"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",metastring:'title="lib/stem_bootstrap.dart" file=<rootDir>/../packages/stem/example/docs_snippets/lib/developer_environment.dart#dev-env-config',children:"  final config = StemConfig.fromEnvironment(Platform.environment);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"connect-adapters",children:"Connect adapters"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",metastring:'title="lib/stem_bootstrap.dart" file=<rootDir>/../packages/stem/example/docs_snippets/lib/developer_environment.dart#dev-env-adapters',children:"  final broker = await RedisStreamsBroker.connect(\n    config.brokerUrl,\n    tls: config.tls,\n  );\n  final backend = await RedisResultBackend.connect(\n    _resolveRedisUrl(config.brokerUrl, config.resultBackendUrl, 1),\n    tls: config.tls,\n  );\n  final revokeStore = await RedisRevokeStore.connect(\n    _resolveRedisUrl(config.brokerUrl, config.revokeStoreUrl, 2),\n  );\n  final routing = await _loadRoutingRegistry(config);\n  final rateLimiter = await connectRateLimiter(config);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"create-the-stem-producer",children:"Create the Stem producer"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",metastring:'title="lib/stem_bootstrap.dart" file=<rootDir>/../packages/stem/example/docs_snippets/lib/developer_environment.dart#dev-env-stem',children:"  final stem = Stem(\n    broker: broker,\n    backend: backend,\n    registry: registry,\n    routing: routing,\n  );\n"})}),"\n",(0,s.jsx)(n.h3,{id:"create-the-worker",children:"Create the worker"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",metastring:'title="lib/stem_bootstrap.dart" file=<rootDir>/../packages/stem/example/docs_snippets/lib/developer_environment.dart#dev-env-worker',children:"  final subscription = _buildSubscription(config);\n  final worker = Worker(\n    broker: broker,\n    backend: backend,\n    registry: registry,\n    revokeStore: revokeStore,\n    rateLimiter: rateLimiter,\n    queue: config.defaultQueue,\n    subscription: subscription,\n    concurrency: 8,\n    autoscale: const WorkerAutoscaleConfig(\n      enabled: true,\n      minConcurrency: 2,\n      maxConcurrency: 16,\n      backlogPerIsolate: 2.0,\n      idlePeriod: Duration(seconds: 45),\n    ),\n  );\n"})}),"\n",(0,s.jsx)(n.p,{children:"Together, these steps give you access to routing, rate limiting, revoke\nstorage, and queue configuration\u2014all backed by Redis."}),"\n",(0,s.jsx)(n.h2,{id:"3-launch-workers-beat-and-producers",children:"3. Launch Workers, Beat, and Producers"}),"\n",(0,s.jsx)(n.p,{children:"With the environment configured, run Stem components from separate terminals:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'# Terminal 1 \u2014 run a worker process (set STEM_WORKER_COMMAND or pass --command).\nexport STEM_WORKER_COMMAND="dart run bin/worker.dart"\nstem worker multi start alpha --queue default --queue reports --queue emails\n\n# Terminal 2 \u2014 apply schedules and run Beat (Dart entrypoint).\nstem schedule apply --file config/schedules.json --yes\nstem schedule list\ndart run packages/stem/example/scheduler_observability/bin/beat.dart\n'})}),"\n",(0,s.jsx)(n.p,{children:"Use a producer entrypoint to enqueue work:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",metastring:'title="lib/producer.dart" file=<rootDir>/../packages/stem/example/docs_snippets/lib/producer.dart#producer-redis',children:"Future<void> enqueueWithRedis() async {\n  final brokerUrl =\n      Platform.environment['STEM_BROKER_URL'] ?? 'redis://localhost:6379';\n\n  final broker = await RedisStreamsBroker.connect(brokerUrl);\n  final backend = await RedisResultBackend.connect('$brokerUrl/1');\n  final registry = SimpleTaskRegistry()\n    ..register(\n      FunctionTaskHandler<void>(\n        name: 'reports.generate',\n        entrypoint: (context, args) async {\n          final id = args['reportId'] as String? ?? 'unknown';\n          print('Queued report $id');\n          return null;\n        },\n      ),\n    );\n\n  final stem = Stem(\n    broker: broker,\n    registry: registry,\n    backend: backend,\n  );\n\n  await stem.enqueue(\n    'reports.generate',\n    args: {'reportId': 'monthly-2025-10'},\n    options: const TaskOptions(queue: 'reports', maxRetries: 3),\n    meta: {'requestedBy': 'finance'},\n  );\n  await backend.close();\n  await broker.close();\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Routing configuration supports default queue aliases, glob-based routing\nrules, and broadcast channels. A minimal ",(0,s.jsx)(n.code,{children:"config/routing.yaml"})," might look like:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'title="config/routing.yaml"',children:"default_queue: critical\nqueues:\n  reports:\n    routing_key: reports.generate\n    priority_range: [2, 7]\n  emails:\n    routing_key: billing.email-*\nbroadcasts:\n  maintenance:\n    delivery: fanout\n"})}),"\n",(0,s.jsx)(n.p,{children:"Stem clamps priorities to queue-defined ranges and publishes broadcast tasks to\nall subscribed workers exactly once per acknowledgement window."}),"\n",(0,s.jsx)(n.h2,{id:"4-coordinate-work-with-canvas-and-result-backend",children:"4. Coordinate Work with Canvas and Result Backend"}),"\n",(0,s.jsx)(n.p,{children:"Now that Redis backs the result store, you can orchestrate more complex\npipelines and query progress from any process:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",metastring:"file=<rootDir>/../packages/stem/example/docs_snippets/lib/developer_environment.dart#dev-env-canvas",children:"Future<void> runCanvasFlows(\n  Bootstrap bootstrap,\n  SimpleTaskRegistry registry,\n) async {\n  final canvas = Canvas(\n    broker: bootstrap.stem.broker,\n    backend: await RedisResultBackend.connect(\n      _resolveRedisUrl(\n        bootstrap.config.brokerUrl,\n        bootstrap.config.resultBackendUrl,\n        1,\n      ),\n    ),\n    registry: registry,\n  );\n\n  final ids = await canvas.group([\n    task('media.resize', args: {'file': 'hero.png'}),\n    task('media.resize', args: {'file': 'thumb.png'}),\n  ], groupId: 'image-assets');\n\n  final chordId = await canvas.chord(\n    body: [\n      task('reports.render', args: {'week': '2024-W28'}),\n      task('reports.render', args: {'week': '2024-W29'}),\n    ],\n    callback: task(\n      'billing.email-receipt',\n      args: {'to': 'finance@example.com'},\n      options: const TaskOptions(queue: 'emails'),\n    ),\n  );\n\n  print('Group dispatched: $ids');\n  print('Chord callback task id: $chordId');\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"Later, you can monitor status from any machine:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",metastring:"file=<rootDir>/../packages/stem/example/docs_snippets/lib/developer_environment.dart#dev-env-status",children:"Future<void> inspectChordStatus(String chordId) async {\n  final backend = await RedisResultBackend.connect(\n    _resolveRedisUrl(\n      Platform.environment['STEM_BROKER_URL']!,\n      Platform.environment['STEM_RESULT_BACKEND_URL'],\n      1,\n    ),\n  );\n  final status = await backend.get(chordId);\n  print('Chord completion state: ${status?.state}');\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"5-listen-to-signals-for-cross-cutting-integrations",children:"5. Listen to Signals for Cross-Cutting Integrations"}),"\n",(0,s.jsx)(n.p,{children:"Signals surface lifecycle milestones that you can pipe into analytics or\nincident tooling:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",metastring:'title="lib/signals.dart" file=<rootDir>/../packages/stem/example/docs_snippets/lib/developer_environment.dart#dev-env-signals',children:"void installSignalHandlers() {\n  StemSignals.taskSucceeded.connect((payload, _) {\n    if (payload.taskName == 'reports.render') {\n      print('Report ${payload.taskId} succeeded');\n    }\n  });\n\n  StemSignals.workerReady.connect((payload, _) {\n    print(\n      'Worker ${payload.worker.id} ready '\n      '(queues=${payload.worker.queues.join(\",\")})',\n    );\n  });\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Call ",(0,s.jsx)(n.code,{children:"installSignalHandlers()"})," during bootstrap before workers or producers\nstart emitting events."]}),"\n",(0,s.jsx)(n.h2,{id:"6-whats-next",children:"6. What\u2019s Next"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Keep the infrastructure running and head to\n",(0,s.jsx)(n.a,{href:"/stem/getting-started/observability-and-ops",children:"Observe & Operate"})," to enable telemetry, inspect\nheartbeats, replay DLQs, and issue remote control commands."]}),"\n",(0,s.jsxs)(n.li,{children:["Browse the runnable examples under ",(0,s.jsx)(n.code,{children:"examples/"})," for Redis/Postgres,\nmixed-cluster, autoscaling, scheduler observability, and signing-key rotation\ndrills you can adapt to your environment."]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>i});var t=r(6540);const s={},a=t.createContext(s);function o(e){const n=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);