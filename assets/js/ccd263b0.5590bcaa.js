"use strict";(globalThis.webpackChunksite=globalThis.webpackChunksite||[]).push([[3956],{1470:(e,n,r)=>{r.d(n,{A:()=>R});var t=r(6540),i=r(4164),a=r(7559),s=r(3104),o=r(6347),l=r(205),c=r(7485),u=r(1682),d=r(679);function g(e){return t.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,t.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function h(e){const{values:n,children:r}=e;return(0,t.useMemo)(()=>{const e=n??function(e){return g(e).map(({props:{value:e,label:n,attributes:r,default:t}})=>({value:e,label:n,attributes:r,default:t}))}(r);return function(e){const n=(0,u.XI)(e,(e,n)=>e.value===n.value);if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e},[n,r])}function p({value:e,tabValues:n}){return n.some(n=>n.value===e)}function m({queryString:e=!1,groupId:n}){const r=(0,o.W6)(),i=function({queryString:e=!1,groupId:n}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:e,groupId:n});return[(0,c.aZ)(i),(0,t.useCallback)(e=>{if(!i)return;const n=new URLSearchParams(r.location.search);n.set(i,e),r.replace({...r.location,search:n.toString()})},[i,r])]}function f(e){const{defaultValue:n,queryString:r=!1,groupId:i}=e,a=h(e),[s,o]=(0,t.useState)(()=>function({defaultValue:e,tabValues:n}){if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!p({value:e,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${n.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}const r=n.find(e=>e.default)??n[0];if(!r)throw new Error("Unexpected error: 0 tabValues");return r.value}({defaultValue:n,tabValues:a})),[c,u]=m({queryString:r,groupId:i}),[g,f]=function({groupId:e}){const n=function(e){return e?`docusaurus.tab.${e}`:null}(e),[r,i]=(0,d.Dv)(n);return[r,(0,t.useCallback)(e=>{n&&i.set(e)},[n,i])]}({groupId:i}),b=(()=>{const e=c??g;return p({value:e,tabValues:a})?e:null})();(0,l.A)(()=>{b&&o(b)},[b]);return{selectedValue:s,selectValue:(0,t.useCallback)(e=>{if(!p({value:e,tabValues:a}))throw new Error(`Can't select invalid tab value=${e}`);o(e),u(e),f(e)},[u,f,a]),tabValues:a}}var b=r(2303);const y={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var x=r(4848);function j({className:e,block:n,selectedValue:r,selectValue:t,tabValues:a}){const o=[],{blockElementScrollPositionUntilNextRender:l}=(0,s.a_)(),c=e=>{const n=e.currentTarget,i=o.indexOf(n),s=a[i].value;s!==r&&(l(n),t(s))},u=e=>{let n=null;switch(e.key){case"Enter":c(e);break;case"ArrowRight":{const r=o.indexOf(e.currentTarget)+1;n=o[r]??o[0];break}case"ArrowLeft":{const r=o.indexOf(e.currentTarget)-1;n=o[r]??o[o.length-1];break}}n?.focus()};return(0,x.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.A)("tabs",{"tabs--block":n},e),children:a.map(({value:e,label:n,attributes:t})=>(0,x.jsx)("li",{role:"tab",tabIndex:r===e?0:-1,"aria-selected":r===e,ref:e=>{o.push(e)},onKeyDown:u,onClick:c,...t,className:(0,i.A)("tabs__item",y.tabItem,t?.className,{"tabs__item--active":r===e}),children:n??e},e))})}function v({lazy:e,children:n,selectedValue:r}){const a=(Array.isArray(n)?n:[n]).filter(Boolean);if(e){const e=a.find(e=>e.props.value===r);return e?(0,t.cloneElement)(e,{className:(0,i.A)("margin-top--md",e.props.className)}):null}return(0,x.jsx)("div",{className:"margin-top--md",children:a.map((e,n)=>(0,t.cloneElement)(e,{key:n,hidden:e.props.value!==r}))})}function k(e){const n=f(e);return(0,x.jsxs)("div",{className:(0,i.A)(a.G.tabs.container,"tabs-container",y.tabList),children:[(0,x.jsx)(j,{...n,...e}),(0,x.jsx)(v,{...n,...e})]})}function R(e){const n=(0,b.A)();return(0,x.jsx)(k,{...e,children:g(e.children)},String(n))}},8453:(e,n,r)=>{r.d(n,{R:()=>s,x:()=>o});var t=r(6540);const i={},a=t.createContext(i);function s(e){const n=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),t.createElement(a.Provider,{value:n},e.children)}},9112:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>u,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"core-concepts/routing","title":"Routing Configuration","description":"Stem workers and publishers resolve queue and broadcast targets from the routing","source":"@site/docs/core-concepts/routing.md","sourceDirName":"core-concepts","slug":"/core-concepts/routing","permalink":"/stem/core-concepts/routing","draft":false,"unlisted":false,"editUrl":"https://github.com/kingwill101/stem/tree/main/.site/docs/docs/core-concepts/routing.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"title":"Routing Configuration","sidebar_label":"Routing","sidebar_position":3,"slug":"/core-concepts/routing"},"sidebar":"docs","previous":{"title":"Namespaces","permalink":"/stem/core-concepts/namespaces"},"next":{"title":"Signals","permalink":"/stem/core-concepts/signals"}}');var i=r(4848),a=r(8453),s=r(1470),o=r(9365);const l={title:"Routing Configuration",sidebar_label:"Routing",sidebar_position:3,slug:"/core-concepts/routing"},c=void 0,u={},d=[{value:"Queue priority ranges",id:"queue-priority-ranges",level:2},{value:"Broadcast channels",id:"broadcast-channels",level:2},{value:"Loading subscriptions",id:"loading-subscriptions",level:2},{value:"Using the config in Dart",id:"using-the-config-in-dart",level:2}];function g(e){const n={code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.p,{children:["Stem workers and publishers resolve queue and broadcast targets from the routing\nfile referenced by ",(0,i.jsx)(n.code,{children:"STEM_ROUTING_CONFIG"}),". The file is parsed into a typed\n",(0,i.jsx)(n.code,{children:"RoutingConfig"}),", validated by the ",(0,i.jsx)(n.code,{children:"RoutingRegistry"}),", and used by helpers such as\n",(0,i.jsx)(n.code,{children:"buildWorkerSubscription"}),". The loader helpers (",(0,i.jsx)(n.code,{children:"RoutingConfigLoader"}),",\n",(0,i.jsx)(n.code,{children:"WorkerSubscriptionBuilder"}),", ",(0,i.jsx)(n.code,{children:"buildWorkerSubscription"}),") live in the ",(0,i.jsx)(n.code,{children:"stem_cli"}),"\npackage and are used by the CLI to produce friendly diagnostics. In application\ncode you can use the core ",(0,i.jsx)(n.code,{children:"stem"})," types directly (see \u201cLoading subscriptions\u201d).\nWhen no file is supplied Stem falls back to a legacy single-queue configuration."]}),"\n","\n",(0,i.jsxs)(s.A,{children:[(0,i.jsx)(o.A,{value:"yaml",label:"config/routing.yaml",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"default_queue:\n  alias: default\n  queue: primary\n  fallbacks:\n    - secondary\nqueues:\n  primary:\n    exchange: jobs\n    routing_key: jobs.default\n    priority_range: [0, 9]\n  secondary: {}\nbroadcasts:\n  control:\n    delivery: at-least-once\n  updates:\n    delivery: at-most-once\nroutes:\n  - match:\n      task: reports.*\n    target:\n      type: queue\n      name: primary\n  - match:\n      task: control.*\n    target:\n      type: broadcast\n      name: control\n"})})}),(0,i.jsx)(o.A,{value:"dart",label:"lib/routing.dart",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",metastring:"file=<rootDir>/../packages/stem/example/docs_snippets/lib/routing.dart#routing-load",children:"Future<RoutingRegistry> loadRouting() async {\n  final source = await File('config/routing.yaml').readAsString();\n  return RoutingRegistry.fromYaml(source);\n}\n\nfinal registry = RoutingRegistry(\n  RoutingConfig(\n    defaultQueue: const DefaultQueueConfig(alias: 'default', queue: 'primary'),\n    queues: {'primary': QueueDefinition(name: 'primary')},\n    routes: [\n      RouteDefinition(\n        match: RouteMatch.fromJson(const {'task': 'reports.*'}),\n        target: RouteTarget(type: 'queue', name: 'primary'),\n      ),\n    ],\n  ),\n);\n"})})})]}),"\n",(0,i.jsx)(n.h2,{id:"queue-priority-ranges",children:"Queue priority ranges"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Each queue definition accepts an optional ",(0,i.jsx)(n.code,{children:"priority_range"})," either as a two\nelement list (",(0,i.jsx)(n.code,{children:"[min, max]"}),") or an object (",(0,i.jsx)(n.code,{children:"{ min: 0, max: 9 }"}),")."]}),"\n",(0,i.jsxs)(n.li,{children:["When omitted, the queue defaults to ",(0,i.jsx)(n.code,{children:"min: 0"}),", ",(0,i.jsx)(n.code,{children:"max: 9"}),". Values outside the\nrange trigger a ",(0,i.jsx)(n.code,{children:"FormatException"})," during load."]}),"\n",(0,i.jsxs)(n.li,{children:["The routing registry clamps any priority assigned via ",(0,i.jsx)(n.code,{children:"RoutingInfo.priority"}),"\nor route overrides into the configured range, guaranteeing that both Redis\nand Postgres brokers store buckets within ",(0,i.jsx)(n.code,{children:"[min, max]"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Publishers may continue to set ",(0,i.jsx)(n.code,{children:"Envelope.priority"}),"; the registry will respect\nthat hint when resolving a route. When no range is defined the value is\nclamped to ",(0,i.jsx)(n.code,{children:"[0, 9]"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",metastring:'title="lib/routing.dart" file=<rootDir>/../packages/stem/example/docs_snippets/lib/routing.dart#routing-priority-range',children:"final priorityQueue = QueueDefinition(\n  name: 'priority',\n  priorityRange: const QueuePriorityRange(min: 0, max: 5),\n);\n\nfinal priorityRegistry = RoutingRegistry(\n  RoutingConfig(\n    defaultQueue: const DefaultQueueConfig(alias: 'default', queue: 'priority'),\n    queues: {'priority': priorityQueue},\n  ),\n);\n"})}),"\n",(0,i.jsx)(n.h2,{id:"broadcast-channels",children:"Broadcast channels"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Add broadcast channels under ",(0,i.jsx)(n.code,{children:"broadcasts"}),"; each entry is keyed by the logical\nchannel name and may declare:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"delivery"}),": semantic hint for consumers. ",(0,i.jsx)(n.code,{children:"at-least-once"})," is the default and\nmatches the behaviour of both Redis Streams and Postgres fan-out tables."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"durability"}),": optional metadata surfaced in ",(0,i.jsx)(n.code,{children:"RoutingInfo.meta"}),". Current\nbrokers treat it as an advisory flag."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Routes may target broadcasts via ",(0,i.jsx)(n.code,{children:"target: { type: broadcast, name: channel }"}),"\nand workers subscribe by listing the channel under ",(0,i.jsx)(n.code,{children:"STEM_WORKER_BROADCASTS"}),"\nor via the CLI ",(0,i.jsx)(n.code,{children:"--broadcast"})," flag."]}),"\n",(0,i.jsxs)(n.li,{children:["Broadcast deliveries reuse the same envelope payload; brokers set\n",(0,i.jsx)(n.code,{children:"RoutingInfo.broadcastChannel"})," to the logical channel and ensure each\nsubscriber receives the message exactly once when acked."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"loading-subscriptions",children:"Loading subscriptions"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"RoutingConfigLoader"}),", ",(0,i.jsx)(n.code,{children:"WorkerSubscriptionBuilder"}),", and\n",(0,i.jsx)(n.code,{children:"buildWorkerSubscription"})," live in the ",(0,i.jsx)(n.code,{children:"stem_cli"})," package. The CLI uses them\nto provide friendly diagnostics and to honor ",(0,i.jsx)(n.code,{children:"--queue"}),"/",(0,i.jsx)(n.code,{children:"--broadcast"})," when\nbuilding worker subscriptions."]}),"\n",(0,i.jsxs)(n.li,{children:["In application code you can either import ",(0,i.jsx)(n.code,{children:"package:stem_cli/stem_cli.dart"}),"\n(see ",(0,i.jsx)(n.code,{children:"packages/stem/example/email_service"}),") or build the registry directly:\nload YAML with ",(0,i.jsx)(n.code,{children:"RoutingConfig.fromYaml"}),", then construct a ",(0,i.jsx)(n.code,{children:"RoutingRegistry"}),"\nand ",(0,i.jsx)(n.code,{children:"RoutingSubscription"})," yourself."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"using-the-config-in-dart",children:"Using the config in Dart"}),"\n",(0,i.jsx)(n.p,{children:"Load the routing file once during service start-up and reuse the registry across\nproducers and workers:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",metastring:'title="lib/routing.dart" file=<rootDir>/../packages/stem/example/docs_snippets/lib/routing.dart#routing-bootstrap',children:"Future<(Stem, Worker)> bootstrapStem() async {\n  final routing = await loadRouting();\n  final registry = SimpleTaskRegistry()..register(EmailTask());\n  final config = StemConfig.fromEnvironment();\n  final subscription = RoutingSubscription(\n    queues: config.workerQueues.isEmpty\n        ? [config.defaultQueue]\n        : config.workerQueues,\n    broadcastChannels: config.workerBroadcasts,\n  );\n\n  final stem = Stem(\n    broker: await RedisStreamsBroker.connect('redis://localhost:6379'),\n    registry: registry,\n    backend: InMemoryResultBackend(),\n    routing: routing,\n  );\n\n  final worker = Worker(\n    broker: await RedisStreamsBroker.connect('redis://localhost:6379'),\n    registry: registry,\n    backend: InMemoryResultBackend(),\n    subscription: subscription,\n  );\n\n  return (stem, worker);\n}\n\nclass EmailTask extends TaskHandler<void> {\n  @override\n  String get name => 'email.send';\n\n  @override\n  TaskOptions get options => const TaskOptions(queue: 'default');\n\n  @override\n  Future<void> call(TaskContext context, Map<String, Object?> args) async {}\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"For lightweight services or tests, you can construct the registry inline:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",metastring:"file=<rootDir>/../packages/stem/example/docs_snippets/lib/routing.dart#routing-inline",children:"final inlineRegistry = RoutingRegistry(\n  RoutingConfig(\n    defaultQueue: const DefaultQueueConfig(alias: 'default', queue: 'primary'),\n    queues: {'primary': QueueDefinition(name: 'primary')},\n    routes: [\n      RouteDefinition(\n        match: RouteMatch.fromJson(const {'task': 'reports.*'}),\n        target: RouteTarget(type: 'queue', name: 'primary'),\n      ),\n    ],\n  ),\n);\n"})}),"\n",(0,i.jsx)(n.p,{children:"Both approaches keep routing logic declarative while letting you evolve queue\ntopology without editing code."})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(g,{...e})}):g(e)}},9365:(e,n,r)=>{r.d(n,{A:()=>s});r(6540);var t=r(4164);const i={tabItem:"tabItem_Ymn6"};var a=r(4848);function s({children:e,hidden:n,className:r}){return(0,a.jsx)("div",{role:"tabpanel",className:(0,t.A)(i.tabItem,r),hidden:n,children:e})}}}]);