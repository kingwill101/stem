#!/usr/bin/env bash
set -euo pipefail

if ! command -v docker >/dev/null 2>&1; then
  echo "This script requires Docker to run trivy." >&2
  exit 1
fi

IMAGE="aquasec/trivy:latest"
SEVERITY="${TRIVY_SEVERITY:-CRITICAL,HIGH}"
FAIL_ON="${TRIVY_FAIL_ON:-1}"

echo "Running Trivy scan (severity: $SEVERITY, fail-on: exit $FAIL_ON)"

docker run --rm \
  -v "$(pwd)":/workspace \
  -w /workspace \
  "$IMAGE" fs \
    --scanners vuln \
    --severity "$SEVERITY" \
    --exit-code "$FAIL_ON" \
    --no-progress \
    .
