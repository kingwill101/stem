set shell := ["bash", "-cu"]

ROOT := justfile_directory() + "/../.."
INIT_ENV := ROOT + "/packages/stem_cli/_init_test_env"
PACKAGE_DIR := justfile_directory()

test:
    @set -euo pipefail; \
      source "{{INIT_ENV}}"; \
      cd "{{PACKAGE_DIR}}"; \
      dart test --fail-fast

coverage:
    @set -euo pipefail; \
      source "{{INIT_ENV}}"; \
      cd "{{PACKAGE_DIR}}"; \
      STEM_CLI_RUN_MULTI=true dart test --fail-fast --coverage=coverage; \
      dart run coverage:format_coverage --lcov --in=coverage --out=coverage/lcov.info --report-on=lib; \
      dart run ../../tool/coverage/coverage_badge.dart --lcov coverage/lcov.info --out coverage/coverage.json --min 80
